name: Python

# This file builds and tests Python binary wheels across major platforms. The
# wheels that are produced are used for PyPi releases. The test step uses a
# fresh job and installs the wheel the ensure it works in isolation. The is also
# a job which produces the source distribution and ensures that can be built to.

on:
  push:
    branches:
      - master
      - 'releases/**'
      - rlos2023/test
  pull_request:
    branches:
      - '*'
      - rlos2023/test

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  # Linux x64 and aarch64 builds using cibuildwheel (Python 3.10-3.13)
  cibuildwheel-build-linux:
    name: cibuildwheel.${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
      fail-fast: false
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.0
      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  # Linux aarch64 builds using cibuildwheel (Python 3.10-3.13)
  cibuildwheel-build-linux-aarch64:
    name: cibuildwheel.ubuntu-24.04-arm
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.0
      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-ubuntu-24.04-arm
          path: ./wheelhouse/*.whl

  linux-python-sdist-bundle:
    name: ubuntu-latest.amd64.py3.10.sdist-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: 'x64'
      - name: Install dependencies
        shell: bash
        run: python setup.py sdist
      - name: Upload built wheel
        uses: actions/upload-artifact@v4
        with:
          name: python_source_distribution
          path: dist/*.tar.gz
          if-no-files-found: error

  linux-python-sdist-build-test:
    name: ubuntu-latest.amd64.py3.10.sdist-build-test
    needs: linux-python-sdist-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v4
      - uses: actions/download-artifact@v4
        with:
          name: python_source_distribution
          path: dist/
      - name: Install dependencies
        shell: bash
        run: |
          sudo apt update
          sudo apt install libboost-test-dev libboost-python-dev zlib1g-dev cmake ninja-build g++
      - name: Install source dist
        shell: bash
        run: pip install dist/*.tar.gz
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install dependencies
        shell: bash
        run: |
          pip install -r requirements.txt
          pip install pytest vw-executor
      - name: Run unit tests
        shell: bash
        run: |
          python -m pytest ./python/tests/

  macos-python-build:
    name: macos.amd64.py${{ matrix.config.version }}.build
    runs-on: macos-15-intel
    strategy:
      matrix:
        config:
        - { version: "3.10", include_dir_name: python3.10/}
        - { version: "3.11", include_dir_name: python3.11/}
        - { version: "3.12", include_dir_name: python3.12/}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ matrix.config.version }}
          miniconda-version: "latest"
      - name: Build wheel
        shell: bash -l {0}
        run: |
          conda info
          conda install python=${{ matrix.config.version }} wheel zlib boost py-boost flatbuffers
          CMAKE_ARGS="-DSTATIC_LINK_VW_JAVA=On -DPython_INCLUDE_DIR=\"$CONDA_PREFIX/include/${{ matrix.config.include_dir_name }}\"" pip wheel . -w wheel_output/ --verbose
      - name: Upload built wheel
        uses: actions/upload-artifact@v4
        with:
          name: macos_amd64_${{ matrix.config.version }}
          path: wheel_output/

  macos-python-test:
    name: macos.amd64.py${{ matrix.version }}.test
    needs: macos-python-build
    runs-on: macos-15-intel
    strategy:
      matrix:
        version: ["3.10", "3.11", "3.12"]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ matrix.version }}
          miniconda-version: "latest"
      - uses: actions/download-artifact@v4
        with:
          name: macos_amd64_${{ matrix.version }}
          path: built_wheel
      - name: Test wheel
        shell: bash -l {0}
        run: |
          conda install python=${{ matrix.version }} boost py-boost
          pip install --force-reinstall built_wheel/*.whl
          pip install -r requirements.txt
          pip install pytest vw-executor twine
          twine check built_wheel/*.whl
          python -m pytest ./python/tests/
          python ./python/tests/run_doctest.py

  windows-python-build:
    name: windows-2019.amd64.py${{ matrix.config.version }}.build
    runs-on: windows-2019
    env:
      VCPKG_ROOT: ${{ github.workspace }}\\vcpkg
      VCPKG_REF: 25b458671af03578e6a34edd8f0d1ac85e084df4
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}\vcpkg_binary_cache
    strategy:
      matrix:
        config:
        - { version: "3.10", boost_py_suffix: "310" }
        - { version: "3.11", boost_py_suffix: "311" }
        - { version: "3.12", boost_py_suffix: "312" }
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ matrix.config.version }}
          miniconda-version: "latest"
          use-mamba: false
      - uses: actions/checkout@v4
        with:
          path: ${{ env.VCPKG_ROOT }}
          repository: 'microsoft/vcpkg'
          ref: ${{ env.VCPKG_REF }}
          fetch-depth: '0'
      - name: Restore vcpkg and build artifacts
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: |
            ${{ env.VCPKG_REF }}-${{ matrix.config.version }}-python-win-conda-cache-1
      - run: ${{ env.VCPKG_ROOT }}/bootstrap-vcpkg.bat
        shell: cmd
      - name: Build wheel
        shell: bash -l {0}
        run: |
          if [ ! -d "${{ env.VCPKG_DEFAULT_BINARY_CACHE }}" ]; then
            mkdir -p "${{ env.VCPKG_DEFAULT_BINARY_CACHE }}"
          fi

          echo "=== Download Boost headers directly ==="
          BOOST_VERSION=1.82.0
          BOOST_VERSION_UNDERSCORE=${BOOST_VERSION//./_}
          BOOST_URL="https://archives.boost.io/release/${BOOST_VERSION}/source/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz"
          BOOST_DIR_WIN="${{ github.workspace }}\boost"
          BOOST_DIR=$(cygpath "$BOOST_DIR_WIN")

          echo "Downloading Boost from: $BOOST_URL"
          curl -L "$BOOST_URL" -o boost.tar.gz
          echo "Downloaded file info:"
          file boost.tar.gz
          ls -lh boost.tar.gz

          echo "Creating Boost directory: $BOOST_DIR"
          mkdir -p "$BOOST_DIR"
          ls -ld "$BOOST_DIR"

          echo "Extracting Boost..."
          tar -xzf boost.tar.gz -C "$BOOST_DIR" --strip-components=1
          rm boost.tar.gz

          echo "Boost extraction complete. Checking boost/python.hpp:"
          ls -la "$BOOST_DIR/boost/python.hpp" || echo "boost/python.hpp not found!"

          echo "=== Install conda dependencies for Python-matched library ==="
          conda info
          # Install py-boost for boost_python${{ matrix.config.boost_py_suffix }}.lib that matches Python ${{ matrix.config.version }}
          conda install -y --quiet python=${{ matrix.config.version }} wheel setuptools pip py-boost zlib flatbuffers

          echo "=== Verify Python version ==="
          python --version
          which python

          echo -e "\n=== Verify installed conda packages ==="
          conda list | grep -E "(boost|python)" || echo "No boost/python packages found"

          echo "=== Verify setup ==="
          echo "CONDA_PREFIX: $CONDA_PREFIX"
          echo "Working directory: $(pwd)"

          echo -e "\n=== Using downloaded Boost headers, conda for libraries ==="
          echo "Converting paths to CMake-friendly format:"
          CONDA_PREFIX_CMAKE=$(cygpath -w "$CONDA_PREFIX" | sed 's/\\/\//g')
          BOOST_DIR_CMAKE=$(cygpath -w "$BOOST_DIR" | sed 's/\\/\//g')
          echo "CONDA_PREFIX_CMAKE: $CONDA_PREFIX_CMAKE"
          echo "BOOST_DIR_CMAKE: $BOOST_DIR_CMAKE"

          CMAKE_OPTIONS="-DSTATIC_LINK_VW_JAVA=On;-DCMAKE_BUILD_TYPE=Release;-DZLIB_ROOT=$CONDA_PREFIX_CMAKE/Library;-DZLIB_INCLUDE_DIR=$CONDA_PREFIX_CMAKE/Library/include;-DZLIB_LIBRARY=$CONDA_PREFIX_CMAKE/Library/lib/zlib.lib;-DBoost_ROOT=$BOOST_DIR_CMAKE;-DBoost_INCLUDE_DIR=$BOOST_DIR_CMAKE;-DBoost_LIBRARY_DIR=$CONDA_PREFIX_CMAKE/Library/lib;-DBoost_PYTHON${{ matrix.config.boost_py_suffix }}_LIBRARY=$CONDA_PREFIX_CMAKE/Library/lib/boost_python${{ matrix.config.boost_py_suffix }}.lib;-DBoost_DIR=NOTFOUND;-DBoost_NO_BOOST_CMAKE=ON;-DBOOST_PY_VERSION_SUFFIX=${{ matrix.config.boost_py_suffix }}"

          echo -e "\n=== Building wheel with setup.py (supports --cmake-options) ==="
          echo "CMAKE_OPTIONS: $CMAKE_OPTIONS"

          python setup.py \
            --cmake-generator="Visual Studio 16 2019" \
            --cmake-options="$CMAKE_OPTIONS" \
            bdist_wheel --dist-dir=wheel_output

          echo -e "\n=== Inspecting built wheel ==="
          WHEEL_FILE=$(ls wheel_output/*.whl | head -1)
          echo "Wheel file: $WHEEL_FILE"

          echo -e "\n=== Extracting wheel to inspect contents ==="
          mkdir -p wheel_inspect
          cd wheel_inspect
          unzip -q "../$WHEEL_FILE"

          echo -e "\n=== Wheel contents (top level) ==="
          ls -la

          echo -e "\n=== Looking for DLL and PYD files ==="
          find . -name "*.dll" -o -name "*.pyd" | while read f; do
            echo "$f ($(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null || echo "?" ) bytes)"
          done

          cd ..
      - name: Upload built wheel
        uses: actions/upload-artifact@v4
        with:
          name: windows_amd64_${{ matrix.config.version }}
          path: wheel_output

  windows-python-test:
    name: ${{ matrix.os }}.amd64.py${{ matrix.version }}.test
    needs: windows-python-build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        version: ["3.10", "3.11", "3.12"]
        os: ["windows-2019"]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.version }}
      - uses: actions/download-artifact@v4
        with:
          name: windows_amd64_${{ matrix.version }}
          path: built_wheel
      - name: Install deps and test wheel
        shell: bash
        run: |
          export wheel_files=(built_wheel/*)
          export wheel_file="${wheel_files[0]}"
          echo Installing ${wheel_file}...
          pip install --force-reinstall ${wheel_file}
          pip install -r requirements.txt
          pip install pytest vw-executor twine

          echo -e "\n=== Quick import test ==="
          python -c "import vowpalwabbit; print('SUCCESS: vowpalwabbit imported successfully!')"

          twine check ${wheel_file}
          python -m pytest .\\python\\tests\\
          python .\\python\\tests\\run_doctest.py
