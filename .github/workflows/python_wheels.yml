name: Python

# This file builds and tests Python binary wheels across major platforms. The
# wheels that are produced are used for PyPi releases. The test step uses a
# fresh job and installs the wheel the ensure it works in isolation. The is also
# a job which produces the source distribution and ensures that can be built to.

on:
  push:
    branches:
      - master
      - 'releases/**'
      - rlos2023/test
  pull_request:
    branches:
      - '*'
      - rlos2023/test
      
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  cibuildwheel-build-linux:
    name: cibuildwheel.${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm]
      fail-fast: false
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.0
      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  cibuildwheel-build-windows-mac:
    name: cibuildwheel.${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    env:
      VW_PYTHON_USE_VCPKG: "1"
      CIBW_ENVIRONMENT_WINDOWS: >
        CMAKE_ARGS="-DCMAKE_TOOLCHAIN_FILE={project}/ext_libs/vcpkg/scripts/buildsystems/vcpkg.cmake -DVW_ZLIB_SYS_DEP=OFF"
      CIBW_BEFORE_BUILD_WINDOWS: >
        pip install delvewheel &&
        cd {project}\\ext_libs\\vcpkg &&
        if not exist vcpkg.exe (call bootstrap-vcpkg.bat) &&
        vcpkg.exe install zlib:x64-windows --recurse
    strategy:
      matrix:
        # macos-15-intel is an Intel runner, macos-14 is Apple silicon
        os: [windows-latest, macos-15-intel, macos-14]
      fail-fast: false
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: '${{ github.workspace }}/ext_libs/vcpkg'
      - name: Build wheels
        uses: pypa/cibuildwheel@v3.3.0
      - uses: actions/upload-artifact@v4
        with:
          name: cibw-wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  linux-python-sdist-bundle:
    name: ubuntu-latest.amd64.py3.8.sdist-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          architecture: 'x64'
      - name: Install dependencies
        shell: bash
        run: python setup.py sdist
      - name: Upload built wheel
        uses: actions/upload-artifact@v4
        with:
          name: python_source_distribution
          path: dist/*.tar.gz
          if-no-files-found: error

  linux-python-sdist-build-test:
    name: ubuntu-latest.amd64.py3.8.sdist-build-test
    needs: linux-python-sdist-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v6
      - uses: actions/download-artifact@v4
        with:
          name: python_source_distribution
          path: dist/
      - name: Install dependencies
        shell: bash
        run: |
          sudo apt update
          sudo apt install libboost-test-dev libboost-python-dev zlib1g-dev cmake ninja-build g++
      - name: Install source dist
        shell: bash
        run: |
          ls -l
          ls -l dist/
          pip install dist/*.tar.gz
      - uses: actions/checkout@v6
        with:
          submodules: recursive
      - name: Install dependencies
        shell: bash
        run: |
          pip install -r requirements.txt
          pip install pytest pyclean vw-executor
      - name: Run unit tests
        shell: bash
        run: |
          python -m pyclean ./python/tests/
          python -m pytest ./python/tests/
