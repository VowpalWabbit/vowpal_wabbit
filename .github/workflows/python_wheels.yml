name: Python

# This file builds and tests Python binary wheels across major platforms. The
# wheels that are produced are used for PyPi releases. The test step uses a
# fresh job and installs the wheel the ensure it works in isolation. The is also
# a job which produces the source distribution and ensures that can be built to.

on:
  push:
    branches:
      - master
      - 'releases/**'
      - rlos2023/test
  pull_request:
    branches:
      - '*'
      - rlos2023/test
      
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  linux-python-build:
    name: manylinux.amd64.py${{ matrix.config.version}}.build
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
        - { version: "3.10", os: "ubuntu-22.04", boost_suffix: "310" }
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libboost-dev libboost-python-dev python3-dev python3-pip zlib1g-dev
      - name: Diagnostic - Check Python and Boost configuration
        shell: bash
        run: |
          echo "=== Python Information ==="
          which python3
          python3 --version
          python3 -c "import sys; print(f'Python path: {sys.executable}')"
          python3 -c "import sysconfig; print(f'Include dir: {sysconfig.get_path(\"include\")}')"

          echo -e "\n=== Boost Python Libraries ==="
          dpkg -L libboost-python-dev | grep -E '\.so' || echo "No .so files found"
          find /usr/lib -name '*boost_python*' 2>/dev/null || echo "No boost_python libs in /usr/lib"

          echo -e "\n=== Boost Version ==="
          dpkg -l | grep libboost-python

          echo -e "\n=== CMake Python Detection Test ==="
          cat > /tmp/test_cmake.txt << 'TESTEOF'
          cmake_minimum_required(VERSION 3.10)
          project(test)
          find_package(Python3 COMPONENTS Interpreter Development)
          find_package(Boost COMPONENTS python3)
          message(STATUS "Python3_FOUND: ${Python3_FOUND}")
          message(STATUS "Python3_VERSION: ${Python3_VERSION}")
          message(STATUS "Python3_EXECUTABLE: ${Python3_EXECUTABLE}")
          message(STATUS "Python3_INCLUDE_DIRS: ${Python3_INCLUDE_DIRS}")
          message(STATUS "Boost_FOUND: ${Boost_FOUND}")
          message(STATUS "Boost_VERSION: ${Boost_VERSION}")
          TESTEOF
          cmake -P /tmp/test_cmake.txt 2>&1 || true
      - name: Build wheel
        shell: bash
        run: |
          python3 -m pip install wheel setuptools auditwheel
          CMAKE_ARGS="-DSTATIC_LINK_VW_JAVA=On -DCMAKE_BUILD_TYPE=Release -DBoost_NO_BOOST_CMAKE=ON" python3 -m pip wheel . -w wheel_output/ --verbose
          auditwheel repair wheel_output/*whl -w audit_output/
      - name: Upload built wheel
        uses: actions/upload-artifact@v4
        with:
          name: manylinux_amd64_${{ matrix.config.version }}
          path: audit_output/
  linux-python-test:
    name: manylinux.amd64.py${{ matrix.version }}.test
    needs: linux-python-build
    container:
      image: python:${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ["3.10"]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/download-artifact@v4
        with:
          name: manylinux_amd64_${{ matrix.version }}
          path: built_wheel
      - name: Test wheel
        shell: bash
        run: |
          pip install -r requirements.txt
          pip install pytest vw-executor twine
          pip install --force-reinstall built_wheel/*.whl
          twine check built_wheel/*.whl
          python -m pytest ./python/tests/
          python ./python/tests/run_doctest.py
      - name: Run vw tests as Python module
        shell: bash
        # Onethread is not supported in the Python wrapper so those tests must be skipped
        # Stdin is not supported
        # Help output tests assume --onthread is in the output
        # Fail tests are not included because the python stack trace causes the output to differ
        # Daemon tests are skipped
        # Tests without datafiles are skipped
        run: |
          cd test
          python run_tests.py -E 0.001 -f --skip_spanning_tree_tests --vw_bin_path "python3 -m vowpalwabbit" --skip_test 60 61 92 96 149 152 177 193 194 195 220 275 276 324 325 326 349 350 356 357 358 385 389 390 391 392 393 400 399 401 403 431 440
  linux-python-sdist-bundle:
    name: ubuntu-latest.amd64.py3.10.sdist-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: 'x64'
      - name: Install dependencies
        shell: bash
        run: python setup.py sdist
      - name: Upload built wheel
        uses: actions/upload-artifact@v4
        with:
          name: python_source_distribution
          path: dist/*.tar.gz
          if-no-files-found: error
  linux-python-sdist-build-test:
    name: ubuntu-latest.amd64.py3.10.sdist-build-test
    needs: linux-python-sdist-bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v4
      - uses: actions/download-artifact@v4
        with:
          name: python_source_distribution
          path: dist/
      - name: Install dependencies
        shell: bash
        run: |
          sudo apt update
          sudo apt install libboost-test-dev libboost-python-dev zlib1g-dev cmake ninja-build g++
      - name: Install source dist
        shell: bash
        run: pip install dist/*.tar.gz
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install dependencies
        shell: bash
        run: |
          pip install -r requirements.txt
          pip install pytest vw-executor
      - name: Run unit tests
        shell: bash
        run: |
          python -m pytest ./python/tests/
  linux-python-build-aarch64:
    name: manylinux.aarch64.py${{ matrix.config.version }}.build
    # Aarch builds are slow and are only run on push and not PR
    if: ${{ github.event_name == 'push' }}
    strategy:
      matrix:
        config:
        - { version: "3.10", base_path: /opt/python/cp310-cp310/, include_dir_name: python3.10/ }
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Set up QEMU
      id: qemu
      uses: docker/setup-qemu-action@v3
    - name: Pull image
      run: docker pull vowpalwabbit/manylinux2014_aarch64-build
    - name: Build Wheel
      run: |
            docker run --rm -v ${{ github.workspace }}:/ws:rw --workdir=/ws \
            vowpalwabbit/manylinux2014_aarch64-build \
            bash -exc 'CMAKE_ARGS="-DSTATIC_LINK_VW_JAVA=On -DPython_INCLUDE_DIR='${{ matrix.config.base_path }}include/${{ matrix.config.include_dir_name }}'" ${{ matrix.config.base_path }}bin/pip wheel . -w wheel_output/ --verbose && \
            auditwheel repair wheel_output/*whl -w audit_output/'
    - name: Upload built wheel
      uses: actions/upload-artifact@v4
      with:
        name: manylinux_aarch64_${{ matrix.config.version }}
        path: audit_output/
  linux-python-test-aarch64:
    name: manylinux.aarch64.py${{ matrix.config.version }}.test
    needs: linux-python-build-aarch64
    # Aarch builds are slow and are only run on push and not PR
    if: ${{ github.event_name == 'push' }}
    strategy:
      matrix:
        config:
        - { version: "3.10" }
      fail-fast: false
    env:
      py: python${{ matrix.config.version }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Set up QEMU
      id: qemu
      uses: docker/setup-qemu-action@v3
    - uses: actions/download-artifact@v4
      with:
        name: manylinux_aarch64_${{ matrix.config.version }}
        path: built_wheel
    - name: Test Wheel
      run: |
            docker run --rm -v ${{ github.workspace }}:/io:rw --workdir=/io \
            arm64v8/ubuntu \
            bash -exc 'apt-get update && \
            apt install software-properties-common -y && \
            add-apt-repository ppa:deadsnakes/ppa -y && \
            DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata && \
            apt install -y ${{ env.py }} && \
            apt install -y ${{ env.py }}-venv && \
            ${{ env.py }} -m venv .env && \
            source .env/bin/activate && \
            pip install --upgrade pip && \
            pip install -r requirements.txt && \
            pip install pytest vw-executor twine && \
            pip install --force-reinstall built_wheel/*.whl && \
            twine check built_wheel/*.whl && \
            python --version && \
            python -m pytest ./python/tests/ && \
            deactivate'
  macos-python-build:
    name: macos.amd64.py${{ matrix.config.version }}.build
    runs-on: macos-15-intel
    strategy:
      matrix:
        config:
        - { version: "3.10", include_dir_name: python3.10/}
        - { version: "3.11", include_dir_name: python3.11/}
        - { version: "3.12", include_dir_name: python3.12/}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ matrix.config.version }}
          miniconda-version: "latest"
      - name: Build wheel
        shell: bash -l {0}
        run: |
          conda info
          conda install python=${{ matrix.config.version }} wheel zlib boost py-boost flatbuffers
          CMAKE_ARGS="-DSTATIC_LINK_VW_JAVA=On -DPython_INCLUDE_DIR=\"$CONDA_PREFIX/include/${{ matrix.config.include_dir_name }}\"" pip wheel . -w wheel_output/ --verbose
      - name: Upload built wheel
        uses: actions/upload-artifact@v4
        with:
          name: macos_amd64_${{ matrix.config.version }}
          path: wheel_output/
  macos-python-test:
    name: macos.amd64.py${{ matrix.version }}.test
    needs: macos-python-build
    runs-on: macos-15-intel
    strategy:
      matrix:
        version: ["3.10", "3.11", "3.12"]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ matrix.version }}
          miniconda-version: "latest"
      - uses: actions/download-artifact@v4
        with:
          name: macos_amd64_${{ matrix.version }}
          path: built_wheel
      - name: Test wheel
        shell: bash -l {0}
        run: |
          conda install py-boost
          pip install -r requirements.txt
          pip install pytest vw-executor twine setuptools scipy scikit-learn
          pip install --force-reinstall built_wheel/*.whl
          twine check built_wheel/*.whl
          python -m pytest ./python/tests/
          python ./python/tests/run_doctest.py
  windows-python-build:
    name: windows-2019.amd64.py${{ matrix.config.version }}.build
    runs-on: windows-2019
    env:
      VCPKG_ROOT: ${{ github.workspace }}\\vcpkg
      VCPKG_REF: 25b458671af03578e6a34edd8f0d1ac85e084df4
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}\vcpkg_binary_cache
    strategy:
      matrix:
        config:
        - { version: "3.10", boost_py_lib: "boost_python310" }
        - { version: "3.11", boost_py_lib: "boost_python311" }
        - { version: "3.12", boost_py_lib: "boost_python312" }
        - { version: "3.13", boost_py_lib: "boost_python313" }
        - { version: "3.14", boost_py_lib: "boost_python314" }
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.config.version }}
      - uses: actions/checkout@v4
        with:
          path: ${{ env.VCPKG_ROOT }}
          repository: 'microsoft/vcpkg'
          ref: ${{ env.VCPKG_REF }}
          fetch-depth: '0'
      - name: Restore vcpkg and build artifacts
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: |
            ${{ env.VCPKG_REF }}-${{ matrix.config.version }}-python-win-vcpkg-cache-1
      - run: ${{ env.VCPKG_ROOT }}/bootstrap-vcpkg.bat
        shell: cmd
      - name: Create vcpkg binary cache directory
        shell: bash
        run: |
          mkdir -p "${{ env.VCPKG_DEFAULT_BINARY_CACHE }}"
      - name: Build Boost.Python and dependencies via vcpkg
        shell: cmd
        run: |
          cd %VCPKG_ROOT%
          vcpkg install boost-python:x64-windows zlib:x64-windows --classic --no-print-usage
      - name: Build wheel
        shell: bash
        run: |
          echo "=== Verify Python version ==="
          python --version
          which python

          echo "=== Setup paths for CMake ==="
          VCPKG_ROOT_UNIX=$(cygpath "${{ env.VCPKG_ROOT }}")
          VCPKG_ROOT_CMAKE=$(cygpath -w "${{ env.VCPKG_ROOT }}" | sed 's/\\/\//g')
          echo "VCPKG_ROOT_CMAKE: $VCPKG_ROOT_CMAKE"

          # vcpkg installs boost-python as boost_python3.lib (generic name for all Python 3.x)
          # Set environment variable to tell CMakeLists.txt to use FindBoost MODULE mode
          # since boost-python alone doesn't provide BoostConfig.cmake files
          export VW_USE_FINDBOOST_MODULE_MODE=1

          # Set BOOST_ROOT to vcpkg installation directory so FindBoost MODULE mode can find it
          export BOOST_ROOT="$VCPKG_ROOT_CMAKE/installed/x64-windows"
          CMAKE_OPTIONS="-DSTATIC_LINK_VW_JAVA=On;-DCMAKE_BUILD_TYPE=Release;-DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT_CMAKE/scripts/buildsystems/vcpkg.cmake;-DVW_ZLIB_SYS_DEP=OFF;-DBoost_NO_BOOST_CMAKE=ON;-DBOOST_ROOT=$BOOST_ROOT;-DBOOST_PY_VERSION_SUFFIX=3"

          echo -e "\n=== Building wheel with setup.py ==="
          echo "CMAKE_OPTIONS: $CMAKE_OPTIONS"

          python -m pip install wheel setuptools
          python setup.py \
            --cmake-generator="Visual Studio 16 2019" \
            --cmake-options="$CMAKE_OPTIONS" \
            bdist_wheel --dist-dir=wheel_output

          echo -e "\n=== Inspecting built wheel ==="
          WHEEL_FILE=$(ls wheel_output/*.whl | head -1)
          echo "Wheel file: $WHEEL_FILE"

          echo -e "\n=== Extracting wheel to inspect contents ==="
          mkdir -p wheel_inspect
          cd wheel_inspect
          unzip -q "../$WHEEL_FILE"

          echo -e "\n=== Wheel contents (top level) ==="
          ls -la

          echo -e "\n=== Looking for DLL and PYD files ==="
          find . -name "*.dll" -o -name "*.pyd" | while read f; do
            echo "$f ($(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null || echo "?" ) bytes)"
          done

          cd ..
      - name: Upload built wheel
        uses: actions/upload-artifact@v4
        with:
          name: windows_amd64_${{ matrix.config.version }}
          path: wheel_output
  windows-python-test:
    name: ${{ matrix.os }}.amd64.py${{ matrix.version }}.test
    needs: windows-python-build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        os: ["windows-2019"]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.version }}
      - uses: actions/download-artifact@v4
        with:
          name: windows_amd64_${{ matrix.version }}
          path: built_wheel
      - name: Install deps and test wheel
        shell: bash
        run: |
          export wheel_files=(built_wheel/*)
          export wheel_file="${wheel_files[0]}"
          echo Installing ${wheel_file}...
          pip install -r requirements.txt
          pip install pytest vw-executor twine
          pip install --force-reinstall ${wheel_file}

          echo -e "\n=== Quick import test ==="
          python -c "import vowpalwabbit; print('SUCCESS: vowpalwabbit imported successfully!')"

          twine check ${wheel_file}
          python -m pytest .\\python\\tests\\
          python .\\python\\tests\\run_doctest.py
