name: AddressSanitizer

on:
  push:
    branches:
      - master
      - 'releases/**'
      - add_test_with_asan
  pull_request:
    branches:
      - '*'

concurrency: 
  group: ${{ github.workflow }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
  build_and_test_asan:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]
    runs-on: ${{matrix.os}}
    env:
      ASAN_OPTIONS: "alloc_dealloc_mismatch=0"

    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - name: Setup MSVC Developer Command Prompt
        if: ${{ startsWith(matrix.os, 'windows') }}
        uses: ilammy/msvc-dev-cmd@v1
      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@master
      - name: Install vcpkg dependencies
        run: vcpkg install zlib boost-test flatbuffers
      - name: Configure
        run: |
          cmake -S . -B build -G Ninja
          -DCMAKE_TOOLCHAIN_FILE="${{ env.VCPKG_INSTALLATION_ROOT }}/scripts/buildsystems/vcpkg.cmake"
          -DVCPKG_MANIFEST_MODE=Off
          -DBUILD_FLATBUFFERS=On
          -DUSE_LATEST_STD=On
          -DVW_USE_ASAN=On
      - name: Build
        run: |
          cmake --build build --config Release
      - name: Run unit tests
        run: |
          cd build
          ctest --verbose --output-on-failure
      - name: Run python test script
        run: |
          python3 test/run_tests.py -f --clean_dirty -E 0.001 --include-flatbuffers
